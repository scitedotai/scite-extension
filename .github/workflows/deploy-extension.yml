name: Deploy Browser Extension

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      target:
        description: 'Target browser(s) to deploy (chrome, firefox, edge, safari, all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - chrome
          - firefox
          - edge
          - safari

jobs:
  build-and-deploy:
    name: Build and Deploy Extension
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for uploading artifacts to releases
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16.18'
          cache: 'npm'

      - name: Get version from package.json
        id: get_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Validate version synchronization
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          MANIFEST_VERSION=$(node -p "require('./extension/manifest.json').version")
          if [ "$PKG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "❌ Version mismatch!"
            echo "package.json: $PKG_VERSION"
            echo "manifest.json: $MANIFEST_VERSION"
            echo "Please ensure both files have the same version number."
            exit 1
          fi
          echo "✅ Versions are synchronized: $PKG_VERSION"

      - name: Create builds directory
        run: mkdir -p ./builds

      - name: Zip source code for Firefox
        run: |
          zip -r ./builds/Source.zip . \
            -x "node_modules/*" \
            -x ".cache/*" \
            -x ".git/*" \
            -x "web-ext-artifacts/*" \
            -x "dist/*" \
            -x "builds/*" \
            -x ".github/*"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test -- --max-workers=2

      - name: Build extension
        run: npm run build

      - name: Zip Chrome extension
        run: |
          cd extension
          zip -r ../builds/ChromeExtension.zip .

      - name: Upload ChromeExtension to release
        if: github.event_name == 'release'
        uses: Shopify/upload-to-release@07611424e04f1475ddf550e1c0dd650b867d5467
        with:
          name: ChromeExtension.zip
          path: ./builds/ChromeExtension.zip
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Chrome Web Store
        if: |
          (github.event_name == 'release') ||
          (github.event_name == 'workflow_dispatch' && 
           (github.event.inputs.target == 'chrome' || github.event.inputs.target == 'all'))
        continue-on-error: true
        uses: wdzeng/chrome-extension@v1
        with:
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          zip-path: ./builds/ChromeExtension.zip

      - name: Sign and publish to Firefox Add-ons
        if: |
          (github.event_name == 'release') ||
          (github.event_name == 'workflow_dispatch' && 
           (github.event.inputs.target == 'firefox' || github.event.inputs.target == 'all'))
        continue-on-error: true
        env:
          FIREFOX_ISSUER: ${{ secrets.FIREFOX_ISSUER }}
          FIREFOX_SECRET: ${{ secrets.FIREFOX_SECRET }}
        run: |
          npx web-ext sign \
            --channel listed \
            -s ./extension/ \
            --upload-source-code ./builds/Source.zip \
            --artifacts-dir ./builds \
            --api-key $FIREFOX_ISSUER \
            --api-secret $FIREFOX_SECRET

      - name: Move Firefox artifact
        if: |
          (github.event_name == 'release') ||
          (github.event_name == 'workflow_dispatch' && 
           (github.event.inputs.target == 'firefox' || github.event.inputs.target == 'all'))
        continue-on-error: true
        run: |
          # Find and rename the signed XPI file
          if ls ./builds/*.xpi 1> /dev/null 2>&1; then
            mv ./builds/*.xpi ./builds/FirefoxExtension.xpi
          fi

      - name: Upload FirefoxExtension to release
        if: github.event_name == 'release'
        continue-on-error: true
        uses: Shopify/upload-to-release@07611424e04f1475ddf550e1c0dd650b867d5467
        with:
          name: FirefoxExtension.xpi
          path: ./builds/FirefoxExtension.xpi
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Zip Edge extension
        run: |
          cd extension
          zip -r ../builds/EdgeExtension.zip .

      - name: Upload EdgeExtension to release
        if: github.event_name == 'release'
        uses: Shopify/upload-to-release@07611424e04f1475ddf550e1c0dd650b867d5467
        with:
          name: EdgeExtension.zip
          path: ./builds/EdgeExtension.zip
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Edge Add-ons
        if: |
          (github.event_name == 'release') ||
          (github.event_name == 'workflow_dispatch' && 
           (github.event.inputs.target == 'edge' || github.event.inputs.target == 'all'))
        continue-on-error: true
        uses: wdzeng/edge-addon@v2
        with:
          product-id: ${{ secrets.EDGE_PRODUCT_ID }}
          zip-path: ./builds/EdgeExtension.zip
          client-id: ${{ secrets.EDGE_CLIENT_ID }}
          client-secret: ${{ secrets.EDGE_CLIENT_SECRET }}
          access-token-url: ${{ secrets.EDGE_ACCESS_TOKEN_URL }}

      - name: Summary
        if: success()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Extension version ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build completed successfully" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "release" ] || \
             [ "${{ github.event.inputs.target }}" == "all" ] || \
             [ "${{ github.event.inputs.target }}" == "chrome" ]; then
            echo "- ✅ Chrome Web Store" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event_name }}" == "release" ] || \
             [ "${{ github.event.inputs.target }}" == "all" ] || \
             [ "${{ github.event.inputs.target }}" == "firefox" ]; then
            echo "- ✅ Firefox Add-ons" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event_name }}" == "release" ] || \
             [ "${{ github.event.inputs.target }}" == "all" ] || \
             [ "${{ github.event.inputs.target }}" == "edge" ]; then
            echo "- ✅ Edge Add-ons" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-safari:
    name: Prepare Safari Deployment
    runs-on: macos-latest
    permissions:
      contents: read  # Only needs to read repository contents
    if: |
      (github.event_name == 'release') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'safari' || github.event.inputs.target == 'all'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16.18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Safari deployment notice
        run: |
          echo "⚠️  Safari deployment requires manual steps in Xcode"
          echo "The Safari extension must be converted and uploaded manually:"
          echo "1. Run: xcrun safari-web-extension-converter ./extension"
          echo "   --project-location . --app-name scite"
          echo "   --bundle-identifier ai.scite --swift"
          echo "2. Set version and build numbers in Xcode"
          echo "3. Build and Archive the project"
          echo "4. Upload to App Store Connect"

      - name: Create Safari deployment artifact
        run: |
          mkdir -p safari-deployment
          cp -r extension safari-deployment/
          cat > safari-deployment/README.md << 'EOF'
          Safari Extension Deployment Instructions

          To deploy to Safari App Store:
          1. Download this artifact
          2. Run: xcrun safari-web-extension-converter ./extension
             --project-location . --app-name scite
             --bundle-identifier ai.scite --swift
          3. Open the generated project in Xcode
          4. Set version in project settings
          5. Archive and upload to App Store Connect
          EOF

      - name: Upload Safari deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: safari-deployment
          path: safari-deployment/
